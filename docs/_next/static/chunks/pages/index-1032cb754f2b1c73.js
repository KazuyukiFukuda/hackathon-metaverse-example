(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(e,t,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return i(3122)}])},7301:function(e,t,i){"use strict";i.d(t,{pT:function(){return c},lW:function(){return s},oA:function(){return o},eR:function(){return l}});var r=i(9520);class n extends r.ZP{constructor(){super("playerModelsDatabase"),this.version(1).stores({models:"++id, item"})}}let a=new n,o=async e=>{let t=e.name.split("."),i=t[t.length-1];if("vrm"!==i)throw Error("is not vrm file");try{await a.models.add({item:e})}catch(e){throw Error("file load error.\n".concat(e))}},l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new URL("".concat(window.location.origin,"/transition"));e.searchParams.append("url",t.toString()),location.href=e.toString()},s=async e=>{if(!window||!window.parent||window.parent===window)return;let t=await a.models.toArray();if(t.length<=0)return;let i=t[t.length-1];window.parent.postMessage(i,e)},c=async e=>new Promise((t,i)=>{let r=new URLSearchParams(e.searchParams);if(r.has("url")){let e=document.createElement("iframe");e.src=r.get("url"),e.width="".concat(0),e.height="".concat(0),document.body.appendChild(e),window.addEventListener("message",async i=>{i.data.item&&(t(i.data),e.remove())},!1)}else i("file load error.")})},3122:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return b}});var r=i(5893),n=i(9008),a=i.n(n),o=i(1502),l=i.n(o),s=i(7294),c=i(7301),m=i(9477),d=i(7836),u=i(8893);let g={mixamorigHips:"hips",mixamorigSpine:"spine",mixamorigSpine1:"chest",mixamorigSpine2:"upperChest",mixamorigNeck:"neck",mixamorigHead:"head",mixamorigLeftShoulder:"leftShoulder",mixamorigLeftArm:"leftUpperArm",mixamorigLeftForeArm:"leftLowerArm",mixamorigLeftHand:"leftHand",mixamorigLeftHandThumb1:"leftThumbMetacarpal",mixamorigLeftHandThumb2:"leftThumbProximal",mixamorigLeftHandThumb3:"leftThumbDistal",mixamorigLeftHandIndex1:"leftIndexProximal",mixamorigLeftHandIndex2:"leftIndexIntermediate",mixamorigLeftHandIndex3:"leftIndexDistal",mixamorigLeftHandMiddle1:"leftMiddleProximal",mixamorigLeftHandMiddle2:"leftMiddleIntermediate",mixamorigLeftHandMiddle3:"leftMiddleDistal",mixamorigLeftHandRing1:"leftRingProximal",mixamorigLeftHandRing2:"leftRingIntermediate",mixamorigLeftHandRing3:"leftRingDistal",mixamorigLeftHandPinky1:"leftLittleProximal",mixamorigLeftHandPinky2:"leftLittleIntermediate",mixamorigLeftHandPinky3:"leftLittleDistal",mixamorigRightShoulder:"rightShoulder",mixamorigRightArm:"rightUpperArm",mixamorigRightForeArm:"rightLowerArm",mixamorigRightHand:"rightHand",mixamorigRightHandPinky1:"rightLittleProximal",mixamorigRightHandPinky2:"rightLittleIntermediate",mixamorigRightHandPinky3:"rightLittleDistal",mixamorigRightHandRing1:"rightRingProximal",mixamorigRightHandRing2:"rightRingIntermediate",mixamorigRightHandRing3:"rightRingDistal",mixamorigRightHandMiddle1:"rightMiddleProximal",mixamorigRightHandMiddle2:"rightMiddleIntermediate",mixamorigRightHandMiddle3:"rightMiddleDistal",mixamorigRightHandIndex1:"rightIndexProximal",mixamorigRightHandIndex2:"rightIndexIntermediate",mixamorigRightHandIndex3:"rightIndexDistal",mixamorigRightHandThumb1:"rightThumbMetacarpal",mixamorigRightHandThumb2:"rightThumbProximal",mixamorigRightHandThumb3:"rightThumbDistal",mixamorigLeftUpLeg:"leftUpperLeg",mixamorigLeftLeg:"leftLowerLeg",mixamorigLeftFoot:"leftFoot",mixamorigLeftToeBase:"leftToes",mixamorigRightUpLeg:"rightUpperLeg",mixamorigRightLeg:"rightLowerLeg",mixamorigRightFoot:"rightFoot",mixamorigRightToeBase:"rightToes"},h=(e,t,i)=>{var r;let n=m.AnimationClip.findByName(t.animations,"mixamo.com"),a=[],o=new m.Quaternion,l=new m.Quaternion,s=new m.Quaternion,c=new m.Vector3,d=t.getObjectByName("mixamorigHips").position.y,u=null===(r=i.humanoid)||void 0===r?void 0:r.getNormalizedBoneNode("hips").getWorldPosition(c).y,h=i.scene.getWorldPosition(c).y,f=Math.abs(u-h)/d;return n.tracks.forEach(e=>{var r,n;let c=e.name.split("."),d=c[0],u=g[d],h=null===(r=null===(n=i.humanoid)||void 0===n?void 0:n.getNormalizedBoneNode(u))||void 0===r?void 0:r.name,p=t.getObjectByName(d);if(null!=h){let t=c[1];if(p.getWorldQuaternion(o).invert(),p.parent.getWorldQuaternion(l),e instanceof m.QuaternionKeyframeTrack){for(let t=0;t<e.values.length;t+=4){let i=e.values.slice(t,t+4);s.fromArray(i),s.premultiply(l).multiply(o),s.toArray(i),i.forEach((i,r)=>{e.values[r+t]=i})}a.push(new m.QuaternionKeyframeTrack("".concat(h,".").concat(t),e.times,e.values.map((e,t)=>{var r;return(null===(r=i.meta)||void 0===r?void 0:r.metaVersion)==="0"&&t%2==0?-e:e})))}else if(e instanceof m.VectorKeyframeTrack){let r=e.values.map((e,t)=>{var r;return((null===(r=i.meta)||void 0===r?void 0:r.metaVersion)==="0"&&t%3!=1?-e:e)*f});a.push(new m.VectorKeyframeTrack("".concat(h,".").concat(t),e.times,r))}}}),new m.AnimationClip(e,n.duration,a)},f=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new m.LoadingManager,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new FileReader;i.readAsArrayBuffer(e);let r=URL.createObjectURL(e);t.setURLModifier(e=>e);let n=new d.E(t);n.register(e=>new u.XX(e));let a=await n.loadAsync(r);return a.userData.vrm},p=e=>{let t=(0,s.useCallback)(t=>{if(t.target.files&&t.target.files.length>0){let i=t.target.files[t.target.files.length-1];(0,c.oA)(i).then(async()=>await f(i)).then(t=>{e.onFileLoad&&e.onFileLoad(t)})}},[]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h1",{children:"VRM読み込み"}),(0,r.jsx)("input",{type:"file",accept:".vrm",onChange:e=>{t(e)}})]})};var x=i(7188),w=i(1411),v=i(299),y=i(105);y.Z.install({THREE:m});let L=(e,t)=>{let i=t.x-e.x,r=t.z-e.z;return Math.atan2(i,r)},R=(e,t,i,r)=>{let n=Math.atan2(t.x,t.z)+i;return{moveDelta:new m.Vector3(e*Math.sin(n)*r,0,e*Math.cos(n)*r),angle:n}},k=e=>{let{camera:t,gl:{domElement:i}}=(0,v.z)(),n=(0,s.useRef)(),a=(0,s.useRef)(0),o=(0,s.useRef)(new m.Vector3(0,0,1)),l=(0,s.useRef)(),c=(0,s.useRef)(),d=(0,s.useRef)();(0,s.useEffect)(()=>{e.playerModel&&(n.current&&u.ck.removeUnnecessaryJoints(n.current.scene),n.current=e.playerModel,u.ck.deepDispose(n.current.scene),n.current.scene.traverse(e=>{e.frustumCulled=!1}),u.ck.rotateVRM0(n.current),d.current=new y.Z(t,i))},[e.playerModel]),(0,s.useEffect)(()=>{e.idolClip&&e.walkClip&&n.current&&(c.current=new m.AnimationMixer(n.current.scene),l.current={idol:c.current.clipAction(e.idolClip),walk:c.current.clipAction(e.walkClip)},l.current.idol.play())},[e.playerModel,e.idolClip,e.walkClip]);let g=(0,s.useCallback)(()=>{n.current&&e.onFrameEvent(n.current)},[e.onFrameEvent]),h=(0,s.useCallback)(e=>{var t,i,r,n,s,c,d,u;switch(e.key){case"w":case"ArrowUp":o.current=new m.Vector3(0,0,1),null===(t=l.current)||void 0===t||t.walk.play(),null===(i=l.current)||void 0===i||i.idol.stop(),a.current=1.5;break;case"a":case"ArrowLeft":o.current=new m.Vector3(1,0,0),null===(r=l.current)||void 0===r||r.walk.play(),null===(n=l.current)||void 0===n||n.idol.stop(),a.current=1.5;break;case"d":case"ArrowRight":o.current=new m.Vector3(-1,0,0),null===(s=l.current)||void 0===s||s.walk.play(),null===(c=l.current)||void 0===c||c.idol.stop(),a.current=1.5;break;case"s":case"ArrowDown":o.current=new m.Vector3(0,0,-1),null===(d=l.current)||void 0===d||d.walk.play(),null===(u=l.current)||void 0===u||u.idol.stop(),a.current=1.5}},[e.playerModel,e.idolClip,e.walkClip]),f=(0,s.useCallback)(e=>{switch(e.key){case"w":case"ArrowUp":case"a":case"ArrowLeft":case"d":case"ArrowRight":case"s":case"ArrowDown":var t,i;null===(t=l.current)||void 0===t||t.idol.play(),null===(i=l.current)||void 0===i||i.walk.stop(),a.current=0}},[e.idolClip,e.walkClip]);return((0,s.useEffect)(()=>{document.addEventListener("keydown",h,!1),document.addEventListener("keyup",f,!1)},[e.playerModel,e.idolClip,e.walkClip]),(0,v.A)((e,t)=>{var i,r,l;if(d.current&&n.current){let e=L(d.current.camera.position,n.current.scene.position),{moveDelta:i,angle:r}=R(a.current,o.current,e,t);n.current.scene.position.x+=i.x,n.current.scene.position.y+=i.y,n.current.scene.position.z+=i.z,a.current>0&&(n.current.scene.rotation.y=r-Math.PI),d.current.camera.position.x+=i.x,d.current.camera.position.y+=i.y,d.current.camera.position.z+=i.z,d.current.setOrbitPoint(n.current.scene.position.x,n.current.scene.position.y+1,n.current.scene.position.z)}g(),null===(i=n.current)||void 0===i||i.update(t),null===(r=c.current)||void 0===r||r.update(t),null===(l=d.current)||void 0===l||l.update(t)}),n.current)?(0,r.jsx)("primitive",{...e,object:n.current.scene,dispose:null}):null},H=e=>{let[t,i]=(0,s.useState)(),[n,a]=(0,s.useState)(),[o,l]=(0,s.useState)();(0,s.useEffect)(()=>{i(e.vrm)},[e.vrm]),(0,s.useEffect)(()=>{if(!t)return;let e=new w.y;e.load("/assets/Happy Idle.fbx",e=>{a(h("idol",e,t))}),e.load("/assets/Walking.fbx",e=>{l(h("walk",e,t))})},[t]);let m=(0,s.useCallback)(e=>{(Math.abs(e.scene.position.x)>5||Math.abs(e.scene.position.z)>5)&&(0,c.eR)(new URL("http://localhost:3000/"))},[t]);return(0,r.jsxs)(x.Xz,{camera:{fov:45,near:.1,far:1e3,position:[0,3,2]},children:[(0,r.jsx)("ambientLight",{}),(0,r.jsx)("pointLight",{position:[5,5,5]}),(0,r.jsx)(k,{onFrameEvent:m,playerModel:t,idolClip:n,walkClip:o}),(0,r.jsx)("gridHelper",{})]})};function b(){let[e,t]=(0,s.useState)();(0,s.useEffect)(()=>{(0,c.pT)(new URL(window.location.href)).then(e=>{console.log(e),(0,c.oA)(e.item).then(async()=>await f(e.item)).then(e=>{t(e),window.history.pushState(null,"","/")})})},[]);let i=(0,s.useCallback)(()=>e?(0,r.jsx)(H,{vrm:e}):(0,r.jsx)(p,{onFileLoad:e=>{t(e)}}),[e]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(a(),{children:[(0,r.jsx)("title",{children:"Create Next App"}),(0,r.jsx)("meta",{name:"description",content:"Generated by create next app"}),(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,r.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,r.jsx)("main",{className:l().main,children:i()})]})}},1502:function(e){e.exports={main:"Home_main__nLjiQ"}}},function(e){e.O(0,[737,86,722,571,774,888,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);